

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Products</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        padding: 30px 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
      }

      .container {
        max-width: 1100px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
        overflow: hidden;
      }

      h1 {
        text-align: center;
        padding: 30px 20px 0;
        color: #1a1a1a;
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 20px;
      }

      /* Form styling */
      #addProductForm {
        margin: 0 20px 20px !important;
        background: #f9fafb !important;
        padding: 20px !important;
        border: 1px solid #e5e7eb !important;
        border-radius: 8px !important;
      }

      #addProductForm > div {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }

      #addProductForm input,
      #addProductForm select {
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.2s ease;
      }

      #addProductForm input:focus,
      #addProductForm select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      }

      #addProductForm button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
        white-space: nowrap;
      }

      #addProductForm button:hover {
        background: #0056b3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 86, 179, 0.3);
      }

      #addProductForm button:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(0, 86, 179, 0.2);
      }

      #addMsg {
        font-weight: 600;
        font-size: 14px;
      }

      /* Table styling */
      #productsTable {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
      }

      #productsTable th {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
        letter-spacing: 0.5px;
        border: none;
      }

      #productsTable td {
        padding: 14px 12px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 14px;
        color: #374151;
      }

      #productsTable tbody tr {
        transition: all 0.2s ease;
        cursor: pointer;
      }

      #productsTable tbody tr:hover {
        background: #f0f9ff;
        box-shadow: inset 0 0 0 1px #bfdbfe;
      }

      #productsTable tbody tr:last-child td {
        border-bottom: none;
      }

      /* Delete button styling */
      .deleteBtn {
        background: #dc2626;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .deleteBtn:hover {
        background: #b91c1c;
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
      }

      .deleteBtn:active {
        transform: scale(0.98);
      }

      /* Edit button styling */
      .editBtn {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-right: 8px;
      }

      .editBtn:hover {
        background: #0056b3;
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 86, 179, 0.3);
      }

      .editBtn:active {
        transform: scale(0.98);
      }

      /* Table wrapper padding */
      #productsTable {
        display: table;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Products</h1>
 
      <!-- Add product form -->
      <form id="addProductForm">
        <div>
          <input
            id="name"
            placeholder="NAME"
            style="flex: 2; min-width: 200px"
          />
          <input
            id="price"
            placeholder="PRICE"
            type="number"
            step="0.01"
            style="width: 110px"
          />
          <input
            id="stock"
            placeholder="STOCK"
            type="number"
            style="width: 110px"
          />
          <select id="category" style="width: 160px;">
            <option value="">Select Category</option>
          </select>
        </div>
        <div style="display: flex; gap: 12px; align-items: center">
          <input id="description" placeholder="DESCRIPTION" style="flex: 1" />
          <button type="submit">Add Product</button>
          <span id="addMsg"></span>
        </div>
      </form>
 
      <table id="productsTable">
        <thead>
          <tr id="headerRow"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
 
    <!-- Modal for product details -->
    <div
      id="productModalOverlay"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      "
    >
      <div
        style="
          background: white;
          padding: 20px;
          border-radius: 8px;
          width: 420px;
          max-height: 80vh;
          overflow: auto;
        "
      >
        <div id="productModalContent"></div>
        <div style="text-align: right; margin-top: 12px">
          <button type="button" onclick="closeProductModal(); return false;">Close</button>
        </div>
      </div>
    </div>
    <script>
      // replace one-off fetch with reusable loader + add-product handler
 
      // Load categories and populate dropdown
      async function loadCategories() {
        try {
          const res = await fetch("http://localhost:3001/categories");
          const data = await res.json();
          if (!data.success) {
            console.error("Failed to load categories");
            return;
          }

          const select = document.getElementById("category");
          const categories = data.categories || [];
          
          categories.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat.CATEGORYID;
            option.textContent = cat.NAME;
            select.appendChild(option);
          });
        } catch (err) {
          console.error("Error loading categories:", err);
        }
      }

      async function loadProducts() {
        const res = await fetch("http://localhost:3001/products");
        const data = await res.json();
        if (!data.success) {
          alert("Failed to load products");
          return;
        }
 
        const rows = data.products || [];
        const headerRow = document.getElementById("headerRow");
        const tableBody = document.getElementById("tableBody");
 
        // clear previous
        headerRow.innerHTML = "";
        tableBody.innerHTML = "";
 
        if (rows.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 5;
          td.textContent = "No products found";
          tr.appendChild(td);
          tableBody.appendChild(tr);
          return;
        }

        // Define visible columns only (ProductID, Description, CategoryID are hidden internally)
        const visibleHeaders = ["NAME", "PRICE", "STOCK", "CATEGORYNAME", "ACTION"];
        
        // Create header row with only visible columns
        visibleHeaders.forEach((h) => {
          const th = document.createElement("th");
          th.textContent = h === "CATEGORYNAME" ? "CATEGORY" : h;
          headerRow.appendChild(th);
        });
 
        // Build a map of CategoryID to CategoryName for display
        const categoryMap = {};
        rows.forEach((row) => {
          if (row.CATEGORYID && row.CATEGORYNAME) {
            categoryMap[row.CATEGORYID] = row.CATEGORYNAME;
          }
        });

        rows.forEach((row) => {
          const tr = document.createElement("tr");
          // Store full product data in dataset for later use
          tr.dataset.productId = row.PRODUCTID;
          tr.dataset.productData = JSON.stringify(row);
 
          // Add visible columns only
          visibleHeaders.forEach((h) => {
            if (h === "ACTION") {
              const td = document.createElement("td");
              td.style.textAlign = "center";
              
              // Edit button
              const editBtn = document.createElement("button");
              editBtn.className = "editBtn";
              editBtn.textContent = "âœï¸ Edit";
              editBtn.setAttribute("data-id", row.PRODUCTID);
              editBtn.addEventListener("click", (e) => handleEditProduct(e, row));
              
              // Delete button
              const deleteBtn = document.createElement("button");
              deleteBtn.className = "deleteBtn";
              deleteBtn.textContent = "ðŸ—‘ï¸ Delete";
              deleteBtn.setAttribute("data-id", row.PRODUCTID);
              deleteBtn.addEventListener("click", handleDeleteProduct);
              
              td.appendChild(editBtn);
              td.appendChild(deleteBtn);
              tr.appendChild(td);
            } else {
              const td = document.createElement("td");
              let content = "";
              
              if (h === "NAME") content = row.NAME;
              else if (h === "PRICE") content = row.PRICE;
              else if (h === "STOCK") content = row.STOCK;
              else if (h === "CATEGORYNAME") content = row.CATEGORYNAME ;
              
              td.textContent = content;
              tr.appendChild(td);
            }
          });
 
          // open modal when clicking the row (excluding buttons)
          tr.addEventListener("click", async (e) => {
            // Don't trigger if button was clicked
            if (e.target.closest("button")) return;
            
            const pid = tr.dataset.productId;
            if (!pid) return;
            await openProductModal(pid);
          });
 
          tableBody.appendChild(tr);
        });
      }
 
      // fetch product details from backend. expects backend to return category_name (joined)
      async function fetchProductDetails(id) {
        try {
          const res = await fetch(
            `http://localhost:3001/product/${encodeURIComponent(id)}`
          );
          if (!res.ok) throw new Error("Network response was not ok");
          const data = await res.json();
          return data;
        } catch (err) {
          console.error("fetchProductDetails error", err);
          return { success: false, message: err.message };
        }
      }
 
      async function showDetails(id) {
        const overlay = document.getElementById("productModalOverlay");
        overlay.style.display = "flex";

        const result = await fetchProductDetails(id);
        if (!result || !result.success) {
          const errMsg =
            result && result.message
              ? "Error: " + result.message
              : "Failed to load product";
          const container = document.getElementById("productModalContent");
          container.innerHTML = `<p>${errMsg}</p>`;
          return;
        }

        const p = result.product;
        showProductModal(p);
      }

      // Render the provided product object into the modal (replaces previous contents)
      function showProductModal(product) {
        const container = document.getElementById("productModalContent");
        // Clear previous contents
        container.innerHTML = "";

        const entries = Object.entries(product || {});
        if (entries.length === 0) {
          container.innerHTML = "<p>No product data available.</p>";
        } else {
          // Build header
          const header = document.createElement("h3");
          header.textContent = "Product Details";
          container.appendChild(header);

          // Build label + input for each field
          const formDiv = document.createElement("div");
          entries.forEach(([k, v]) => {
            const fieldDiv = document.createElement("div");
            fieldDiv.style.marginBottom = "12px";

            const label = document.createElement("label");
            label.textContent = k;
            label.style.display = "block";
            label.style.marginBottom = "4px";
            label.style.fontWeight = "bold";
            label.style.fontSize = "14px";

            const input = document.createElement("input");
            input.type = "text";
            input.value = v ?? "";
            input.readOnly = true;
            input.style.width = "100%";
            input.style.padding = "8px";
            input.style.border = "1px solid #ccc";
            input.style.borderRadius = "4px";
            input.style.boxSizing = "border-box";
            input.style.backgroundColor = "#f5f5f5";

            fieldDiv.appendChild(label);
            fieldDiv.appendChild(input);
            formDiv.appendChild(fieldDiv);
          });
          container.appendChild(formDiv);
        }

        // Ensure modal is visible
        document.getElementById("productModalOverlay").style.display = "flex";
      }
 
      async function openProductModal(id) {
        await showDetails(id);
      }

      // modal close handler
      function closeProductModal() {
        const overlay = document.getElementById("productModalOverlay");
        if (overlay) {
          overlay.style.display = "none";
        }
      }
      (function setupModalHandlers() {
        const overlay = document.getElementById("productModalOverlay");
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) overlay.style.display = "none";
        });
      })();
 
      document
        .getElementById("addProductForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = document.getElementById("addProductForm");
          const NAME = document.getElementById("name").value.trim();
          const PRICE = document.getElementById("price").value;
          const STOCK = document.getElementById("stock").value;
          const DESCRIPTION = document
            .getElementById("description")
            .value.trim();
          const CATEGORYID = document.getElementById("category").value.trim();
          const msgEl = document.getElementById("addMsg");
          const isEditMode = form.dataset.editMode === "true";
          const productId = form.dataset.productId;
 
          msgEl.textContent = "";
 
          if (!NAME || PRICE === "") {
            msgEl.style.color = "red";
            msgEl.textContent = "Name and Price are required.";
            return;
          }
 
          try {
            // Handle update mode
            if (isEditMode && productId) {
              const res = await fetch(`http://localhost:3001/updateProduct/${productId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  NAME,
                  DESCRIPTION,
                  PRICE: Number(PRICE),
                  STOCK: STOCK === "" ? null : Number(STOCK),
                  CATEGORYID: CATEGORYID || null,
                }),
              });
 
              const result = await res.json();
              if (result.success) {
                msgEl.style.color = "green";
                msgEl.textContent = "Product updated successfully.";
                // Reset form and edit mode
                document.getElementById("addProductForm").reset();
                form.dataset.editMode = "false";
                delete form.dataset.productId;
                const submitBtn = form.querySelector("button[type='submit']");
                submitBtn.textContent = "Add Product";
                submitBtn.style.backgroundColor = "";
                // reload products
                setTimeout(() => loadProducts(), 1000);
              } else {
                msgEl.style.color = "red";
                msgEl.textContent = result.message || "Failed to update product";
              }
            } else {
              // Handle add mode
              const res = await fetch("http://localhost:3001/addProduct", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  NAME,
                  DESCRIPTION,
                  PRICE: Number(PRICE),
                  STOCK: STOCK === "" ? null : Number(STOCK),
                  CATEGORYID: CATEGORYID || null,
                }),
              });
 
              const result = await res.json();
              if (result.success) {
                msgEl.style.color = "green";
                msgEl.textContent = "Product added.";
                // clear form fields
                document.getElementById("addProductForm").reset();
                // reload products
                loadProducts();
              } else {
                msgEl.style.color = "red";
                msgEl.textContent = result.message || "Failed to add product";
              }
            }
          } catch (err) {
            msgEl.style.color = "red";
            msgEl.textContent = "Error: " + err.message;
          }
        });
 
      // Handle Edit Product
      async function handleEditProduct(e, product) {
        e.stopPropagation();
        e.preventDefault();

        // Pre-fill the form with product data
        document.getElementById("name").value = product.NAME || "";
        document.getElementById("price").value = product.PRICE || "";
        document.getElementById("stock").value = product.STOCK || "";
        document.getElementById("description").value = product.DESCRIPTION || "";
        document.getElementById("category").value = product.CATEGORYID || "";

        // Store the product ID for update
        const form = document.getElementById("addProductForm");
        form.dataset.editMode = "true";
        form.dataset.productId = product.PRODUCTID;

        // Change button text and color
        const submitBtn = form.querySelector("button[type='submit']");
        submitBtn.textContent = "Update Product";
        submitBtn.style.backgroundColor = "#007bff";

        // Scroll to form
        document.getElementById("addProductForm").scrollIntoView({ behavior: "smooth" });
      }

      // initial load
      async function handleDeleteProduct(e) {
        // Stop the event from bubbling up to the row click handler
        e.stopPropagation();
        e.preventDefault();

        const btn = e.target;
        const productId = btn.getAttribute("data-id");
        console.log("Deleting product:", productId);

        // Show confirmation dialog
        if (!confirm("Are you sure you want to delete this product?")) {
          return;
        }
 
        try {
          const res = await fetch(
            `http://localhost:3001/delete-product/${productId}`,
            {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
            }
          );
 
          const result = await res.json();
 
          if (result.success) {
            // Remove the row from the table dynamically
            const row = btn.closest("tr");
            if (row) row.remove();
            alert("Product deleted successfully");
          } else {
            // Check if it's a foreign key constraint error
            const message = result.message || "Failed to delete product";
            if (
              message.includes("ORA-02292") ||
              message.includes("ORA-02391") ||
              message.includes("constraint") ||
              message.includes("foreign key")
            ) {
              alert("This product cannot be deleted because it is linked to existing orders.");
            } else {
              alert(message);
            }
          }
        } catch (err) {
          alert("Error: " + err.message);
        }
      }
 
      // Initialize page
      loadCategories();
      loadProducts();
    </script>
  </body>
</html>