<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Products</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <style>
      /* RESET */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      /* PAGE */
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        padding: 30px 20px;
        background: linear-gradient(135deg, #c5d7df 0%, #eef6fa 100%);
        min-height: 100vh;
      }

      /* MAIN CONTAINER */
      .container {
        margin-block: 20px !important;
        max-width: 1100px;
        margin: auto;
        background: white;
        border-radius: 14px;
        box-shadow: 0 14px 45px rgba(45, 89, 131, 0.25);
        overflow: hidden;
      }

      /* TITLE */
      h1 {
        text-align: center;
        padding: 30px 20px 15px;
        color: #2d5983;
        font-size: 30px;
        font-weight: 700;
      }

      /* FORM */
      #addProductForm {
        margin: 20px;
        background: #f8fbfd;
        padding: 20px;
        border: 1px solid #c5d7df;
        border-radius: 12px;
      }
      #addProductForm > div {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }
      #addProductForm input,
      #addProductForm select {
        padding: 11px 12px;
        border: 1px solid #c5d7df;
        border-radius: 8px;
        font-size: 14px;
        transition: 0.2s;
      }

      #addProductForm input:focus,
      #addProductForm select:focus {
        border-color: #499aac;
        box-shadow: 0 0 0 3px rgba(73, 154, 172, 0.25);
        outline: none;
      }

      /* PRIMARY BUTTON */
      #addProductForm button,
      .editBtn {
        background: linear-gradient(135deg, #2d5983, #499aac);
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 20px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.25s ease;
      }

      #addProductForm button:hover,
      .editBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(45, 89, 131, 0.4);
      }

      /* DELETE BUTTON */
      .deleteBtn {
        background: #ae0000;
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 20px;
        font-weight: 700;
        cursor: pointer;
        transition: 0.2s;
      }

      .deleteBtn:hover {
        background: #8d0000;
        box-shadow: 0 6px 16px rgba(174, 0, 0, 0.45);
      }

      /* Action icon buttons (View / Edit / Delete) */
      .action-btn {
        width: 40px;
        height: 40px;
        padding: 0;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: none;
        color: #fff;
        transition: all 0.18s ease;
        margin: 0 6px;
      }

      .action-btn .bi {
        font-size: 18px;
      }

      .action-btn.view,
      .action-btn.edit {
        background: linear-gradient(135deg, #2d5983, #499aac);
      }

      .action-btn.view:hover,
      .action-btn.edit:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(45, 89, 131, 0.28);
      }

      .action-btn.delete {
        background: #ae0000;
      }

      .action-btn.delete:hover {
        background: #8d0000;
        box-shadow: 0 6px 16px rgba(174, 0, 0, 0.45);
      }

      /* TABLE */
      #productsTable {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }

      #productsTable th {
        background: linear-gradient(135deg, #2d5983, #499aac);
        color: white;
        padding: 16px;
        font-size: 14px;
        text-align: left;
      }

      #productsTable td {
        padding: 14px;
        border-bottom: 1px solid #c5d7df;
        color: #2d5983;
      }

      #productsTable tbody tr:hover {
        background: #eef6fa;
      }

      /* MODAL OVERLAY */
      #productModalOverlay {
        background: #c5d7df;
        backdrop-filter: blur(6px);
      }

      /* MODAL CONTENT */
      #productModalContent h3 {
        color: #2d5983;
        margin-bottom: 20px;
      }

      /* MODAL INPUTS */
      #productModalContent input {
        background: #f5fafc;
        border: 1px solid #c5d7df;
        border-radius: 20px;
        padding: 10px;
        color: #2d5983;
      }

      /* ===== PRODUCT DETAILS CLOSE BUTTON ===== */

      /* div يلي فيه زر Close */
      #productModalOverlay > div > div:last-child {
        margin-top: 0 !important;
        padding: 14px 20px;
        background: #f5fafc;
        border-top: 1px solid #c5d7df;
        text-align: right;
      }

      /* زر Close نفسه */
      #productModalOverlay > div > div:last-child button {
        background: linear-gradient(135deg, #2d5983, #499aac);
        color: white;
        border: none;
        padding: 8px 22px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: 0.2s ease;
      }

      /* Hover */
      #productModalOverlay > div > div:last-child button:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(45, 89, 131, 0.35);
      }
    </style>
  </head>
  <body>
    <!-- Inlined navbar (from nav_bar.html) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <style>
      :root {
        --bg: #2d5983; /* navbar background primary */
        --primary: #2d5983;
        --secondary: #499aac; /* for highlights, badge, sign up text */
        --card-radius: 12px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #c5d7df, #eef6fa);
        min-height: 100vh;
        color: #203040;
      }

      /* NAVBAR */
      .navbar {
        background: var(--bg);
        box-shadow: 0 6px 18px rgba(45, 89, 131, 0.18);
        position: sticky;
        top: 0;
        z-index: 50;
      }

      .navbar-container {
        max-width: 1200px;
        margin: auto;
        padding: 12px 20px;
        display: flex;
        gap: 16px;
        align-items: center;
        justify-content: space-between;
      }

      /* LOGO */
      .logo {
        display: flex;
        gap: 10px;
        align-items: center;
        font-weight: 800;
        color: #fff; /* logo white */
        font-size: 20px;
        user-select: none;
      }
      .logo i {
        font-size: 26px;
        transform: translateY(-2px);
      }

      /* LINKS - desktop */
      .nav-links {
        list-style: none;
        display: flex;
        gap: 26px;
        align-items: center;
      }
      .nav-links li {
        position: relative;
      }
      .nav-links a {
        text-decoration: none;
        color: #fff; /* links white */
        font-weight: 600;
        padding: 8px 0;
        display: inline-block;
        transition: transform 0.18s ease, color 0.18s ease;
      }
      .nav-links a::after {
        content: "";
        position: absolute;
        left: 0;
        bottom: -6px;
        width: 0;
        height: 3px;
        background: var(--secondary); /* underline secondary */
        border-radius: 3px;
        transition: width 0.28s cubic-bezier(0.2, 0.9, 0.2, 1);
      }
      .nav-links a:hover,
      .nav-links a.active {
        color: #fff;
      }
      .nav-links a:hover::after,
      .nav-links a.active::after {
        width: 100%;
      }

      /* dropdown */
      .dropdown {
        cursor: pointer;
        padding: 6px 8px;
        border-radius: 8px;
      }
      .dropdown-menu {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        min-width: 160px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 12px 30px rgba(20, 40, 60, 0.12);
        overflow: hidden;
        opacity: 0;
        transform: translateY(6px) scale(0.98);
        transform-origin: top left;
        transition: opacity 0.18s ease, transform 0.18s ease;
        pointer-events: none;
        z-index: 40;
      }
      .dropdown:hover .dropdown-menu,
      .dropdown:focus-within .dropdown-menu {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
      }
      .dropdown-menu a {
        display: block;
        padding: 10px 12px;
        color: #213240;
        text-decoration: none;
        font-weight: 600;
      }
      .dropdown-menu a:hover {
        background: rgba(0, 0, 0, 0.04);
      }

      /* auth buttons */
      .auth-buttons {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .btn {
        padding: 10px 22px;
        font-weight: 700;
        border-radius: 999px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: transform 0.12s ease, box-shadow 0.12s ease,
          background 0.3s ease, color 0.3s ease, background-position 0.3s ease;
        user-select: none;
        background-size: 200% 200%;
      }

      .btn:active {
        transform: translateY(1px) scale(0.995);
      }

      /* Sign In button: gradient animation on hover */
      .btn-signin {
        background: linear-gradient(45deg, var(--primary), #1f4567);
        color: #fff;
        border-color: var(--primary);
        box-shadow: 0 6px 18px rgba(45, 89, 131, 0.08);
      }
      .btn-signin:hover {
        background-position: right center;
        box-shadow: 0 10px 28px rgba(45, 89, 131, 0.14);
      }

      /* Sign Up button: background white, text secondary, gradient on hover */
      .btn-signup {
        background: #fff;
        color: var(--secondary);
        box-shadow: 0 6px 18px rgba(45, 89, 131, 0.08);
        border-color: rgba(255, 255, 255, 0.06);
      }
      .btn-signup:hover {
        background: linear-gradient(90deg, #fff, #eef6fa);
        color: var(--secondary);
        box-shadow: 0 10px 28px rgba(45, 89, 131, 0.1);
      }

      /* small badge next to signup */
      .btn-signup .badge {
        background: var(--secondary); /* badge "New" */
        color: white;
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        margin-left: 8px;
        font-weight: 800;
      }

      /* hamburger (mobile) */
      .hamburger {
        display: none;
        width: 44px;
        height: 44px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.85);
        align-items: center;
        justify-content: center;
        box-shadow: 0 6px 18px rgba(20, 40, 60, 0.06);
        cursor: pointer;
        border: 1px solid rgba(0, 0, 0, 0.04);
      }
      .hamburger i {
        font-size: 20px;
        color: #fff;
      }

      /* mobile menu */
      .mobile-menu {
        display: none;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.95), white);
        box-shadow: 0 14px 40px rgba(20, 40, 60, 0.08);
        border-top: 1px solid rgba(0, 0, 0, 0.03);
      }
      .mobile-menu.open {
        display: block;
      }
      .mobile-links {
        list-style: none;
        padding: 12px 18px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .mobile-links a {
        padding: 10px;
        border-radius: 8px;
        text-decoration: none;
        color: var(--secondary);
        font-weight: 700;
      }
      .mobile-links a:hover {
        background: rgba(0, 0, 0, 0.03);
      }

      @media (max-width: 900px) {
        .nav-links {
          display: none;
        }
        .hamburger {
          display: flex;
        }
        .auth-buttons {
          display: none;
        }
      }

      /* content box */
      .page-content {
        max-width: 1200px;
        margin: 36px auto;
        padding: 28px;
        background: white;
        border-radius: var(--card-radius);
        box-shadow: 0 12px 36px rgba(45, 89, 131, 0.12);
      }
    </style>

    <nav class="navbar">
      <div class="navbar-container">
        <!-- LOGO -->
        <div
          class="logo"
          onclick="location.href='home.html'"
          style="cursor: pointer"
        >
          <i class="fa-solid fa-boxes-stacked"></i>
          <span>StockManager</span>
        </div>

        <!-- desktop links -->
        <ul class="nav-links" role="menubar">
          <li><a href="home.html" data-page="home">Home</a></li>
          <li class="dropdown" tabindex="0">
            <a class="dropdown-toggle" data-page="products"
              >Products
              <i
                class="fa-solid fa-caret-down"
                style="font-size: 12px; margin-left: 6px; color: #fff"
              ></i
            ></a>
            <div class="dropdown-menu" role="menu" aria-hidden="true">
              <a href="products.html" data-page="products">All Products</a>

              <a href="categories.html" data-page="categories">Categories</a>
            </div>
          </li>
          <li><a href="dashboard.html" data-page="dashboard">Dashboard</a></li>
          <li><a href="users.html" data-page="users">Users</a></li>
          <li><a href="orders.html" data-page="orders">Orders</a></li>
        </ul>

        <!-- auth + hamburger -->
        <div style="display: flex; align-items: center; gap: 12px">
          <div class="auth-buttons">
            <button
              class="btn btn-signin"
              onclick="location.href='sign-in.html'"
            >
              Sign In
            </button>
            <button
              class="btn btn-signup"
              onclick="location.href='sign-up.html'"
            >
              Sign Up <span class="badge">New</span>
            </button>
          </div>

          <button class="hamburger" aria-label="Toggle menu" id="hambtn">
            <i class="fa-solid fa-bars"></i>
          </button>
        </div>
      </div>

      <!-- Mobile menu -->
      <div class="mobile-menu" id="mobileMenu" aria-hidden="true">
        <ul class="mobile-links">
          <li><a href="home.html">Home</a></li>
          <li><a href="dashboard.html">Dashboard</a></li>
          <li><a href="products.html">Products</a></li>

          <li><a href="users.html">Users</a></li>
          <li><a href="orders.html">Orders</a></li>
          <li
            style="padding-top: 8px; border-top: 1px solid rgba(0, 0, 0, 0.04)"
          >
            <a href="sign-in.html">Sign In</a>
          </li>
          <li><a href="sign-up.html">Sign Up</a></li>
        </ul>
      </div>
    </nav>

    <script>
      // Set active navbar link based on current page
      (function setActiveNavLink() {
        const currentPage =
          window.location.pathname.split("/").pop() || "home.html";
        document.querySelectorAll(".nav-links a[data-page]").forEach((link) => {
          if (currentPage.includes(link.getAttribute("data-page"))) {
            link.classList.add("active");
          }
        });
      })();

      const btn = document.getElementById("hambtn");
      const menu = document.getElementById("mobileMenu");
      let open = false;
      if (btn) {
        btn.addEventListener("click", () => {
          open = !open;
          menu.classList.toggle("open", open);
          menu.setAttribute("aria-hidden", !open);
          const i = btn.querySelector("i");
          if (i) {
            i.classList.toggle("fa-bars", !open);
            i.classList.toggle("fa-xmark", open);
          }
        });

        document.querySelectorAll(".mobile-links a").forEach((a) => {
          a.addEventListener("click", () => {
            open = false;
            menu.classList.remove("open");
            menu.setAttribute("aria-hidden", "true");
            const i2 = btn.querySelector("i");
            if (i2) {
              i2.classList.remove("fa-xmark");
              i2.classList.add("fa-bars");
            }
          });
        });

        document.querySelectorAll(".dropdown").forEach((el) => {
          el.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              const first = el.querySelector(".dropdown-menu a");
              if (first) first.focus();
            }
          });
        });
      }
    </script>

    <div class="container mt-10 mb-4">
      <h1>Products</h1>

      <!-- Add product form -->
      <form id="addProductForm">
        <div>
          <input
            id="name"
            placeholder="NAME"
            style="flex: 2; min-width: 200px"
          />
          <input
            id="price"
            placeholder="PRICE"
            type="number"
            min="0"
            step="0.01"
            style="width: 110px"
          />
          <input
            id="stock"
            placeholder="STOCK"
            type="number"
            min="0"
            style="width: 110px"
          />
          <select id="category" style="width: 160px">
            <option value="">Select Category</option>
          </select>
        </div>
        <div style="display: flex; gap: 12px; align-items: center">
          <input id="description" placeholder="DESCRIPTION" style="flex: 1" />
          <button type="submit">Add Product</button>
          <span id="addMsg"></span>
        </div>
      </form>

      <table id="productsTable">
        <thead>
          <tr id="headerRow"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Modal for product details -->
    <div
      id="productModalOverlay"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      "
    >
      <div
        style="
          background: white;
          padding: 20px;
          border-radius: 8px;
          width: 420px;
          max-height: 80vh;
          overflow: auto;
        "
      >
        <div id="productModalContent"></div>
        <div style="text-align: right; margin-top: 12px">
          <button type="button" onclick="closeProductModal(); return false;">
            Close
          </button>
        </div>
      </div>
    </div>
    <script>
      // replace one-off fetch with reusable loader + add-product handler

      // Load categories and populate dropdown
      async function loadCategories() {
        try {
          const res = await fetch("http://localhost:3001/categories");
          const data = await res.json();
          if (!data.success) {
            console.error("Failed to load categories");
            return;
          }

          const select = document.getElementById("category");
          const categories = data.categories || [];

          categories.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat.CATEGORYID;
            option.textContent = cat.NAME;
            select.appendChild(option);
          });
        } catch (err) {
          console.error("Error loading categories:", err);
        }
      }

      async function loadProducts() {
        const res = await fetch("http://localhost:3001/products");
        const data = await res.json();
        if (!data.success) {
          alert("Failed to load products");
          return;
        }

        const rows = data.products || [];
        const headerRow = document.getElementById("headerRow");
        const tableBody = document.getElementById("tableBody");

        // clear previous
        headerRow.innerHTML = "";
        tableBody.innerHTML = "";

        if (rows.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 5;
          td.textContent = "No products found";
          tr.appendChild(td);
          tableBody.appendChild(tr);
          return;
        }

        // Define visible columns only (ProductID, Description, CategoryID are hidden internally)
        const visibleHeaders = [
          "PRODUCTNAME",
          "PRICE",
          "STOCK",
          "CATEGORYNAME",
          "ACTION",
        ];

        // Create header row with only visible columns
        visibleHeaders.forEach((h) => {
          const th = document.createElement("th");
          th.textContent = h === "CATEGORYNAME" ? "CATEGORYNAME" : h;
          headerRow.appendChild(th);
        });

        // Build a map of CategoryID to CategoryName for display
        const categoryMap = {};
        rows.forEach((row) => {
          if (row.CATEGORYID && row.CATEGORYNAME) {
            categoryMap[row.CATEGORYID] = row.CATEGORYNAME;
          }
        });

        rows.forEach((row) => {
          const tr = document.createElement("tr");
          // Store full product data in dataset for later use
          tr.dataset.productId = row.PRODUCTID;
          tr.dataset.productData = JSON.stringify(row);

          // Add visible columns only
          visibleHeaders.forEach((h) => {
            if (h === "ACTION") {
              const td = document.createElement("td");
              td.style.textAlign = "left";
              // View button (shows product details in modal on same page)
              const viewBtn = document.createElement("button");
              viewBtn.type = "button";
              viewBtn.className = "action-btn view text-left";
              viewBtn.setAttribute("title", "View");
              viewBtn.innerHTML =
                '<i class="bi bi-eye" aria-hidden="true"></i>';
              viewBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                // Use existing product data from the row
                showProductDetailsModal(row);
              });

              // Edit button (icon-only, logic unchanged)
              const editBtn = document.createElement("button");
              editBtn.type = "button";
              editBtn.className = "action-btn edit";
              editBtn.setAttribute("data-id", row.PRODUCTID);
              editBtn.setAttribute("title", "Edit");
              editBtn.innerHTML =
                '<i class="bi bi-pencil" aria-hidden="true"></i>';
              editBtn.addEventListener("click", (e) =>
                handleEditProduct(e, row)
              );

              // Delete button (icon-only, logic unchanged)
              const deleteBtn = document.createElement("button");
              deleteBtn.type = "button";
              deleteBtn.className = "action-btn delete";
              deleteBtn.setAttribute("data-id", row.PRODUCTID);
              deleteBtn.setAttribute("title", "Delete");
              deleteBtn.innerHTML =
                '<i class="bi bi-trash" aria-hidden="true"></i>';
              deleteBtn.addEventListener("click", handleDeleteProduct);

              td.appendChild(viewBtn);
              td.appendChild(editBtn);
              td.appendChild(deleteBtn);
              tr.appendChild(td);
            } else {
              const td = document.createElement("td");
              let content = "";

              if (h === "PRODUCTNAME") content = row.PRODUCTNAME;
              else if (h === "PRICE") content = row.PRICE;
              else if (h === "STOCK") content = row.STOCK;
              else if (h === "CATEGORYNAME") content = row.CATEGORYNAME;

              td.textContent = content;
              tr.appendChild(td);
            }
          });

          // Row click intentionally does nothing; interactions via action buttons only

          tableBody.appendChild(tr);
        });
      }

      // fetch product details from backend. expects backend to return category_name (joined)
      async function fetchProductDetails(id) {
        try {
          const res = await fetch(
            `http://localhost:3001/product/${encodeURIComponent(id)}`
          );
          if (!res.ok) throw new Error("Network response was not ok");
          const data = await res.json();
          return data;
        } catch (err) {
          console.error("fetchProductDetails error", err);
          return { success: false, message: err.message };
        }
      }

      // Show Product Details modal using data already loaded in the page
      function showProductDetailsModal(product) {
        const container = document.getElementById("productModalContent");
        // Clear previous contents
        container.innerHTML = "";

        if (!product) {
          container.innerHTML = "<p>No product data available.</p>";
          return;
        }

        // Build header
        const header = document.createElement("h3");
        header.textContent = "Product Details";
        container.appendChild(header);

        // Build label + input for each field (display only, readonly)
        const formDiv = document.createElement("div");

        // Display specific fields in order: NAME, PRICE, STOCK, CATEGORYNAME, DESCRIPTION
        // Skip PRODUCTID (do not show in UI)
        const fields = [
          { key: "NAME", label: "Name", value: product.PRODUCTNAME || "" },
          { key: "PRICE", label: "Price", value: product.PRICE || "" },
          { key: "STOCK", label: "Stock", value: product.STOCK ?? "" },
          {
            key: "CATEGORYNAME",
            label: "Category",
            value: product.CATEGORYNAME || "",
          },
          {
            key: "DESCRIPTION",
            label: "Description",
            value: product.DESCRIPTION || "",
          },
        ];

        fields.forEach(({ label, value }) => {
          const fieldDiv = document.createElement("div");
          fieldDiv.style.marginBottom = "12px";

          const labelEl = document.createElement("label");
          labelEl.textContent = label;
          labelEl.style.display = "block";
          labelEl.style.marginBottom = "4px";
          labelEl.style.fontWeight = "bold";
          labelEl.style.fontSize = "14px";

          const input = document.createElement("input");
          input.type = "text";
          input.value = value;
          input.readOnly = true;
          input.style.width = "100%";
          input.style.padding = "8px";
          input.style.border = "1px solid #ccc";
          input.style.borderRadius = "4px";
          input.style.boxSizing = "border-box";
          input.style.backgroundColor = "#f5f5f5";

          fieldDiv.appendChild(labelEl);
          fieldDiv.appendChild(input);
          formDiv.appendChild(fieldDiv);
        });

        container.appendChild(formDiv);

        // Open the modal
        document.getElementById("productModalOverlay").style.display = "flex";
      }

      async function showDetails(id) {
        const overlay = document.getElementById("productModalOverlay");
        overlay.style.display = "flex";

        const result = await fetchProductDetails(id);
        if (!result || !result.success) {
          const errMsg =
            result && result.message
              ? "Error: " + result.message
              : "Failed to load product";
          const container = document.getElementById("productModalContent");
          container.innerHTML = `<p>${errMsg}</p>`;
          return;
        }

        const p = result.product;
        showProductModal(p);
      }

      // Render the provided product object into the modal (replaces previous contents)
      function showProductModal(product) {
        const container = document.getElementById("productModalContent");
        // Clear previous contents
        container.innerHTML = "";

        const entries = Object.entries(product || {});
        if (entries.length === 0) {
          container.innerHTML = "<p>No product data available.</p>";
        } else {
          // Build header
          const header = document.createElement("h3");
          header.textContent = "Product Details";
          container.appendChild(header);

          // Build label + input for each field (skip PRODUCTID - keep data in JS only)
          const formDiv = document.createElement("div");
          entries.forEach(([k, v]) => {
            // Do not render ProductID field in the HTML
            if (k === "PRODUCTID" || k === "ProductID") return;

            const fieldDiv = document.createElement("div");
            fieldDiv.style.marginBottom = "12px";

            const label = document.createElement("label");
            label.textContent = k;
            label.style.display = "block";
            label.style.marginBottom = "4px";
            label.style.fontWeight = "bold";
            label.style.fontSize = "14px";

            const input = document.createElement("input");
            input.type = "text";
            input.value = v ?? "";
            input.readOnly = true;
            input.style.width = "100%";
            input.style.padding = "8px";
            input.style.border = "1px solid #ccc";
            input.style.borderRadius = "4px";
            input.style.boxSizing = "border-box";
            input.style.backgroundColor = "#f5f5f5";

            fieldDiv.appendChild(label);
            fieldDiv.appendChild(input);
            formDiv.appendChild(fieldDiv);
          });
          container.appendChild(formDiv);
        }

        // Ensure modal is visible
        document.getElementById("productModalOverlay").style.display = "flex";
      }

      async function openProductModal(id) {
        await showDetails(id);
      }

      // modal close handler
      function closeProductModal() {
        const overlay = document.getElementById("productModalOverlay");
        if (overlay) {
          overlay.style.display = "none";
        }
      }
      (function setupModalHandlers() {
        const overlay = document.getElementById("productModalOverlay");
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) overlay.style.display = "none";
        });
      })();

      document
        .getElementById("addProductForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const form = document.getElementById("addProductForm");
          const NAME = document.getElementById("name").value.trim();
          const PRICE = document.getElementById("price").value;
          const STOCK = document.getElementById("stock").value;
          const DESCRIPTION = document
            .getElementById("description")
            .value.trim();
          const categorySelect = document.getElementById("category");
          const CATEGORYNAME =
            categorySelect.options[categorySelect.selectedIndex].text;

          const msgEl = document.getElementById("addMsg");
          const isEditMode = form.dataset.editMode === "true";
          const productId = form.dataset.productId;

          msgEl.textContent = "";

          if (!NAME || PRICE === "") {
            msgEl.style.color = "red";
            msgEl.textContent = "Name and Price are required.";
            return;
          }

          try {
            // Handle update mode
            const CATEGORYID = document.getElementById("category").value;

            if (isEditMode && productId) {
              const res = await fetch(
                `http://localhost:3001/updateProduct/${productId}`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    NAME,
                    DESCRIPTION,
                    PRICE: Number(PRICE),
                    STOCK: STOCK === "" ? null : Number(STOCK),
                    CATEGORYID: CATEGORYID || null,
                  }),
                }
              );

              const result = await res.json();
              if (result.success) {
                msgEl.style.color = "green";
                msgEl.textContent = "Product updated successfully.";
                // Reset form and edit mode
                document.getElementById("addProductForm").reset();
                form.dataset.editMode = "false";
                delete form.dataset.productId;
                const submitBtn = form.querySelector("button[type='submit']");
                submitBtn.textContent = "Add Product";
                submitBtn.style.backgroundColor = "";
                // reload products
                setTimeout(() => loadProducts(), 1000);
              } else {
                msgEl.style.color = "red";
                msgEl.textContent =
                  result.message || "Failed to update product";
              }
            } else {
              // Handle add mode
              const res = await fetch("http://localhost:3001/addProduct", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  NAME,
                  DESCRIPTION,
                  PRICE: Number(PRICE),
                  STOCK: STOCK === "" ? null : Number(STOCK),
                  CATEGORYNAME,
                }),
              });

              const result = await res.json();
              if (result.success) {
                msgEl.style.color = "green";
                msgEl.textContent = "Product added.";
                // clear form fields
                document.getElementById("addProductForm").reset();
                // reload products
                loadProducts();
              } else {
                msgEl.style.color = "red";
                msgEl.textContent = result.message || "Failed to add product";
              }
            }
          } catch (err) {
            msgEl.style.color = "red";
            msgEl.textContent = "Error: " + err.message;
          }
        });

      // Handle Edit Product
      async function handleEditProduct(e, product) {
        e.stopPropagation();
        e.preventDefault();

        // Pre-fill the form with product data
        document.getElementById("name").value = product.PRODUCTNAME || "";
        document.getElementById("price").value = product.PRICE || "";
        document.getElementById("stock").value = product.STOCK || "";
        document.getElementById("description").value =
          product.DESCRIPTION || "";
        document.getElementById("category").value = product.CATEGORYID || "";

        // Store the product ID for update
        const form = document.getElementById("addProductForm");
        form.dataset.editMode = "true";
        form.dataset.productId = product.PRODUCTID;

        // Change button text and color
        const submitBtn = form.querySelector("button[type='submit']");
        submitBtn.textContent = "Update Product";
        submitBtn.style.backgroundColor = "#007bff";

        // Scroll to form
        document
          .getElementById("addProductForm")
          .scrollIntoView({ behavior: "smooth" });
      }

      // initial load
      async function handleDeleteProduct(e) {
        // Stop the event from bubbling up to the row click handler
        e.stopPropagation();
        e.preventDefault();

        // Normalize to the button element in case an inner icon was clicked
        const btn =
          e.target.closest && e.target.closest("button")
            ? e.target.closest("button")
            : e.target;
        // Try dataset first, then attribute, then fallback to row dataset
        let productId =
          btn && btn.dataset && btn.dataset.id
            ? btn.dataset.id
            : btn.getAttribute && btn.getAttribute("data-id");
        if ((!productId || productId === "") && btn && btn.closest) {
          const row = btn.closest("tr");
          productId = row && row.dataset ? row.dataset.productId : productId;
        }

        // Coerce to number and validate
        const pidNum = Number(productId);
        if (!productId || Number.isNaN(pidNum)) {
          alert("Failed to delete product: invalid product id");
          return;
        }
        console.log("Deleting product:", pidNum);

        // Show confirmation dialog
        if (!confirm("Are you sure you want to delete this product?")) {
          return;
        }

        try {
          const res = await fetch(
            `http://localhost:3001/delete-product/${pidNum}`,
            {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
            }
          );

          const result = await res.json();

          if (result.success) {
            // Remove the row from the table dynamically
            const row = btn.closest("tr");
            if (row) row.remove();
            alert("Product deleted successfully");
          } else {
            // Check if it's a foreign key constraint error
            const message = result.message || "Failed to delete product";
            if (
              message.includes("ORA-02292") ||
              message.includes("ORA-02391") ||
              message.includes("constraint") ||
              message.includes("foreign key")
            ) {
              alert(
                "This product cannot be deleted because it is linked to existing orders."
              );
            } else {
              alert(message);
            }
          }
        } catch (err) {
          alert("Error: " + err.message);
        }
      }

      // Initialize page
      loadCategories();
      loadProducts();
    </script>
  </body>
</html>
