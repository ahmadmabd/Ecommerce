<!-- product.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Products</title>
    <style>
      body {
        font-family: Arial;
        padding: 20px;
        background: #f4f4f4;
      }
      h1 {
        text-align: center;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
      }
      th,
      td {
        padding: 10px;
        border: 1px solid #ccc;
      }
      th {
        background: #007bff;
        color: white;
      }
      tr:nth-child(even) {
        background: #f9f9f9;
      }
      .container {
        max-width: 900px;
        margin: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Products</h1>

      <!-- Add product form -->
      <form
        id="addProductForm"
        style="
          margin: 20px 0;
          background: #fff;
          padding: 12px;
          border: 1px solid #ddd;
        "
      >
        <div style="display: flex; gap: 8px; flex-wrap: wrap">
          <input
            id="productId"
            placeholder="PRODUCTID"
            style="flex: 1; min-width: 140px"
          />
          <input
            id="name"
            placeholder="NAME"
            style="flex: 2; min-width: 200px"
          />
          <input
            id="price"
            placeholder="PRICE"
            type="number"
            step="0.01"
            style="width: 110px"
          />
          <input
            id="stock"
            placeholder="STOCK"
            type="number"
            style="width: 110px"
          />
          <input
            id="categoryId"
            placeholder="CATEGORYID"
            style="width: 140px"
          />
        </div>
        <div
          style="margin-top: 8px; display: flex; gap: 8px; align-items: center"
        >
          <input id="description" placeholder="DESCRIPTION" style="flex: 1" />
          <button type="submit" style="padding: 6px 12px">Add Product</button>
          <span id="addMsg" style="color: green"></span>
        </div>
      </form>

      <table id="productsTable">
        <thead>
          <tr id="headerRow"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <script>
      // replace one-off fetch with reusable loader + add-product handler

      async function loadProducts() {
        const res = await fetch("http://localhost:3001/products");
        const data = await res.json();
        if (!data.success) {
          alert("Failed to load products");
          return;
        }

        const rows = data.products || [];
        const headerRow = document.getElementById("headerRow");
        const tableBody = document.getElementById("tableBody");

        // clear previous
        headerRow.innerHTML = "";
        tableBody.innerHTML = "";

        if (rows.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 6;
          td.textContent = "No products found";
          tr.appendChild(td);
          tableBody.appendChild(tr);
          return;
        }

        const headers = Object.keys(rows[0]);
        headers.forEach((h) => {
          const th = document.createElement("th");
          th.textContent = h;
          headerRow.appendChild(th);
        });

        rows.forEach((row) => {
          const tr = document.createElement("tr");
          headers.forEach((h) => {
            const td = document.createElement("td");
            td.textContent = row[h];
            tr.appendChild(td);
          });
          tableBody.appendChild(tr);
        });
      }

      document
        .getElementById("addProductForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const PRODUCTID = document.getElementById("productId").value.trim();
          const NAME = document.getElementById("name").value.trim();
          const PRICE = document.getElementById("price").value;
          const STOCK = document.getElementById("stock").value;
          const DESCRIPTION = document
            .getElementById("description")
            .value.trim();
          const CATEGORYID = document.getElementById("categoryId").value.trim();
          const msgEl = document.getElementById("addMsg");

          msgEl.textContent = "";

          if (!PRODUCTID || !NAME || PRICE === "") {
            msgEl.style.color = "red";
            msgEl.textContent = "PRODUCTID, NAME and PRICE are required.";
            return;
          }

          try {
            const res = await fetch("http://localhost:3001/addProduct", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                PRODUCTID,
                NAME,
                DESCRIPTION,
                PRICE: Number(PRICE),
                STOCK: STOCK === "" ? null : Number(STOCK),
                CATEGORYID,
              }),
            });

            const result = await res.json();
            if (result.success) {
              msgEl.style.color = "green";
              msgEl.textContent = "Product added.";
              // clear form fields
              document.getElementById("addProductForm").reset();
              // reload products
              loadProducts();
            } else {
              msgEl.style.color = "red";
              msgEl.textContent = result.message || "Failed to add product";
            }
          } catch (err) {
            msgEl.style.color = "red";
            msgEl.textContent = "Error: " + err.message;
          }
        });

      // initial load
      loadProducts();
    </script>
  </body>
</html>
