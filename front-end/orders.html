<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Orders List</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #2d5983;
        --secondary: #499aac;
        --light-bg: #c5d7df;
        --card-radius: 12px;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        background: linear-gradient(180deg, var(--light-bg) 0%, #f4f7fa 100%);
      }
      .page-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 32px;
      }
      .orders-card {
        width: 100%;
        max-width: 1100px;
        border-radius: var(--card-radius);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        background: #fff;
      }
      .card-header-custom {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: #ffffff;
        padding: 20px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      .card-header-custom h1 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        gap: 0.6rem;
        align-items: center;
      }
      .card-body {
        padding: 20px;
      }
      .table-responsive {
        margin-top: 8px;
      }
      .muted {
        color: #6c757d;
      }
      .state-loading,
      .state-empty,
      .state-error {
        padding: 28px;
        text-align: center;
        color: #334;
      }

      /* Modal product list */
      .product-list {
        max-height: 220px;
        overflow: auto;
        border: 1px solid #e6e6e6;
        border-radius: 10px;
        padding: 10px;
        background: #fff;
      }
      .product-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 6px 2px;
        border-bottom: 1px dashed #eee;
      }
      .product-row:last-child {
        border-bottom: 0;
      }
      .product-name {
        font-weight: 600;
      }
      .product-price {
        color: #2d5983;
        white-space: nowrap;
      }
      .selected-table td,
      .selected-table th {
        vertical-align: middle;
      }
      .qty-input {
        width: 80px;
      }
    </style>
  </head>

  <body>
    <div class="page-container">
      <div class="orders-card">
        <!-- HEADER -->
        <div class="card-header-custom">
          <h1>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              fill="currentColor"
              viewBox="0 0 16 16"
              style="color: rgba(255, 255, 255, 0.95)"
            >
              <path
                d="M8 0a2 2 0 0 0-2 2v1H3a2 2 0 0 0-2 2v7.5A1.5 1.5 0 0 0 2.5 14H13a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2H10V2a2 2 0 0 0-2-2z"
              />
            </svg>
            Orders List
          </h1>

          <div class="d-flex align-items-center gap-2 flex-wrap">
            <!-- SEARCH -->
            <input
              id="searchInput"
              type="text"
              class="form-control form-control-sm"
              placeholder="Search by customer or product..."
              style="max-width: 260px"
            />
            <button class="btn btn-light btn-sm" onclick="onSearch()">
              Search
            </button>

            <!-- PLACE ORDER -->
            <button
              class="btn btn-warning btn-sm"
              onclick="openPlaceOrderModal()"
            >
              + Place Order
            </button>
          </div>
        </div>

        <!-- BODY -->
        <div class="card-body">
          <div id="status" class="state-loading">Loading orders…</div>

          <div id="tableWrap" class="table-responsive d-none">
            <table
              id="ordersTable"
              class="table table-striped table-hover align-middle"
            >
              <thead class="table-light">
                <tr>
                  <th>Order ID</th>
                  <th>Total</th>
                  <th>Date Ordered</th>
                  <th>Status</th>
                  <th>Customer</th>
                  <th>Product</th>
                </tr>
              </thead>
              <tbody id="ordersBody"></tbody>
            </table>
          </div>

          <div id="empty" class="state-empty d-none">
            <div class="h6">No orders found</div>
            <p class="muted">No matching orders were found.</p>
          </div>

          <div id="error" class="state-error d-none">
            <div class="h6 text-danger">Failed to load orders</div>
            <p class="muted" id="errorMsg"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- PLACE ORDER MODAL -->
    <div
      class="modal fade"
      id="placeOrderModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Place New Order</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>

          <div class="modal-body">
            <!-- USER -->
            <div class="mb-3">
              <label class="form-label">Select Customer</label>
              <select id="userSelect" class="form-select">
                <option value="">Loading users…</option>
              </select>
            </div>

            <!-- PRODUCT SEARCH -->
            <div class="mb-2">
              <label class="form-label">Search Products</label>
              <input
                id="productSearch"
                type="text"
                class="form-control"
                placeholder="Type to filter products..."
              />
              <div class="form-text">
                Select multiple products. Default quantity = 1.
              </div>
            </div>

            <!-- PRODUCT LIST (checkboxes) -->
            <div id="productList" class="product-list mb-3"></div>

            <!-- SELECTED PRODUCTS TABLE -->
            <div class="mb-2">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-1">Selected Products</h6>
                <div>
                  <strong>Total: </strong>
                  <span id="totalPrice">0.00</span>
                </div>
              </div>

              <table class="table table-sm table-bordered selected-table mt-2">
                <thead class="table-light">
                  <tr>
                    <th style="width: 40%">Product</th>
                    <th style="width: 15%">Unit Price</th>
                    <th style="width: 15%">Qty</th>
                    <th style="width: 15%">Line Total</th>
                    <th style="width: 15%"></th>
                  </tr>
                </thead>
                <tbody id="selectedBody">
                  <tr>
                    <td colspan="5" class="text-center muted">
                      No products selected.
                    </td>
                  </tr>
                </tbody>
              </table>

              <!-- hidden total input (if you want to send it, but API recomputes anyway) -->
              <input type="hidden" id="totalHidden" value="0" />
            </div>

            <div id="placeOrderAlert" class="alert d-none" role="alert"></div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Cancel
            </button>
            <button class="btn btn-primary" onclick="placeOrderNow()">
              Place Order Now
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS bundle (required for modal) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const API_BASE = "http://localhost:3001";

      let placeOrderModalInstance = null;

      // cache data
      let allUsers = [];
      let allProducts = [];

      // selected products map: productId -> { productId, name, price, quantity }
      const selected = new Map();

      async function fetchOrders(searchText = "") {
        const statusEl = document.getElementById("status");
        const tableWrap = document.getElementById("tableWrap");
        const ordersBody = document.getElementById("ordersBody");
        const emptyEl = document.getElementById("empty");
        const errorEl = document.getElementById("error");
        const errorMsg = document.getElementById("errorMsg");

        function showState(state) {
          statusEl.classList.add("d-none");
          tableWrap.classList.add("d-none");
          emptyEl.classList.add("d-none");
          errorEl.classList.add("d-none");
          if (state === "loading") statusEl.classList.remove("d-none");
          if (state === "table") tableWrap.classList.remove("d-none");
          if (state === "empty") emptyEl.classList.remove("d-none");
          if (state === "error") errorEl.classList.remove("d-none");
        }

        showState("loading");

        try {
          const url = searchText
            ? `${API_BASE}/orders/search/${encodeURIComponent(searchText)}`
            : `${API_BASE}/orders`;

          const res = await fetch(url);
          if (!res.ok) {
            errorMsg.textContent = `Server returned ${res.status}`;
            showState("error");
            return;
          }

          const data = await res.json();
          if (!data.success) {
            errorMsg.textContent = data.message || "Unexpected response";
            showState("error");
            return;
          }

          const rows = data.results || data.orders || [];
          if (rows.length === 0) {
            showState("empty");
            return;
          }

          ordersBody.innerHTML = "";
          rows.forEach((r) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${r.ORDERID ?? ""}</td>
              <td>${r.TOTAL ? Number(r.TOTAL).toFixed(2) : ""}</td>
              <td>${
                r.DATEORDERED
                  ? new Date(r.DATEORDERED).toLocaleDateString()
                  : ""
              }</td>
              <td>${r.STATUS ?? ""}</td>
              <td>${r.CUSTOMERNAME ?? r.FULLNAME ?? ""}</td>
              <td>${r.PRODUCTNAME ?? "-"}</td>
            `;
            ordersBody.appendChild(tr);
          });

          showState("table");
        } catch (err) {
          errorMsg.textContent = err.message || String(err);
          showState("error");
        }
      }

      function onSearch() {
        const value = document.getElementById("searchInput").value.trim();
        fetchOrders(value);
      }

      document
        .getElementById("searchInput")
        .addEventListener("keydown", (e) => {
          if (e.key === "Enter") onSearch();
        });

      // ---------------- MODAL / PLACE ORDER ----------------

      async function openPlaceOrderModal() {
        // init modal instance
        if (!placeOrderModalInstance) {
          placeOrderModalInstance = new bootstrap.Modal(
            document.getElementById("placeOrderModal")
          );
        }

        // reset UI state
        selected.clear();
        document.getElementById("productSearch").value = "";
        setAlert("", "d-none");

        // Load users + products (once)
        await Promise.all([loadUsers(), loadProducts()]);

        // render product list + selected table
        renderProductList();
        renderSelectedTable();

        placeOrderModalInstance.show();
      }

      function setAlert(message, type) {
        const el = document.getElementById("placeOrderAlert");
        el.className = "alert"; // reset
        if (!message) {
          el.classList.add("d-none");
          el.textContent = "";
          return;
        }
        el.classList.remove("d-none");
        el.classList.add(type); // e.g. alert-danger, alert-success
        el.textContent = message;
      }

      async function loadUsers() {
        if (allUsers.length > 0) return;

        const userSelect = document.getElementById("userSelect");
        userSelect.innerHTML = `<option value="">Loading users…</option>`;

        const res = await fetch(`${API_BASE}/users`);
        const data = await res.json();

        if (!data.success) {
          userSelect.innerHTML = `<option value="">Failed to load users</option>`;
          return;
        }

        // from your /users endpoint: vw_user_profile => USERID, FULLNAME, EMAIL
        allUsers = data.users || [];

        userSelect.innerHTML = `<option value="">-- Select User --</option>`;
        allUsers.forEach((u) => {
          const opt = document.createElement("option");
          opt.value = u.USERID;
          opt.textContent = `${u.FULLNAME} (${u.EMAIL})`;
          userSelect.appendChild(opt);
        });
      }

      async function loadProducts() {
        if (allProducts.length > 0) return;

        const res = await fetch(`${API_BASE}/products`);
        const data = await res.json();

        if (!data.success) {
          allProducts = [];
          return;
        }

        // /products returns vw_Public_Products columns:
        // PRODUCTID, PRODUCTNAME, PRICE, STOCK, DESCRIPTION, CATEGORYNAME, CATEGORYID
        allProducts = (data.products || []).map((p) => ({
          productId: p.PRODUCTID,
          name: p.PRODUCTNAME,
          price: Number(p.PRICE || 0),
          stock: Number(p.STOCK || 0),
        }));
      }

      document.getElementById("productSearch").addEventListener("input", () => {
        renderProductList();
      });

      function renderProductList() {
        const listEl = document.getElementById("productList");
        const filter = document
          .getElementById("productSearch")
          .value.trim()
          .toLowerCase();

        const filtered = allProducts.filter((p) => {
          const text = `${p.name} ${p.price}`.toLowerCase();
          return text.includes(filter);
        });

        if (filtered.length === 0) {
          listEl.innerHTML = `<div class="muted text-center p-3">No products match your search.</div>`;
          return;
        }

        listEl.innerHTML = "";
        filtered.forEach((p) => {
          const checked = selected.has(p.productId) ? "checked" : "";
          const disabled = p.stock <= 0 ? "disabled" : "";
          const stockBadge =
            p.stock <= 0
              ? `<span class="badge bg-danger">Out</span>`
              : `<span class="badge bg-success">In</span>`;

          const row = document.createElement("div");
          row.className = "product-row";
          row.innerHTML = `
            <div class="form-check m-0">
              <input class="form-check-input" type="checkbox" id="p_${
                p.productId
              }" ${checked} ${disabled}>
              <label class="form-check-label" for="p_${p.productId}">
                <span class="product-name">${p.name}</span>
                <span class="muted"> (Stock: ${p.stock})</span>
              </label>
            </div>
            <div class="d-flex align-items-center gap-2">
              ${stockBadge}
              <span class="product-price">$${p.price.toFixed(2)}</span>
            </div>
          `;

          row.querySelector("input").addEventListener("change", (e) => {
            if (e.target.checked) {
              selected.set(p.productId, {
                productId: p.productId,
                name: p.name,
                price: p.price,
                quantity: 1,
              });
            } else {
              selected.delete(p.productId);
            }
            renderSelectedTable();
          });

          listEl.appendChild(row);
        });
      }

      function renderSelectedTable() {
        const body = document.getElementById("selectedBody");

        if (selected.size === 0) {
          body.innerHTML = `
            <tr>
              <td colspan="5" class="text-center muted">
                No products selected.
              </td>
            </tr>`;
          updateTotal();
          return;
        }

        body.innerHTML = "";
        for (const item of selected.values()) {
          const tr = document.createElement("tr");
          const lineTotal = item.price * item.quantity;

          tr.innerHTML = `
            <td>${item.name}</td>
            <td>$${item.price.toFixed(2)}</td>
            <td>
              <input type="number" min="1" class="form-control form-control-sm qty-input" value="${
                item.quantity
              }">
            </td>
            <td>$<span class="lineTotal">${lineTotal.toFixed(2)}</span></td>
            <td>
              <button class="btn btn-sm btn-outline-danger">Remove</button>
            </td>
          `;

          // quantity change
          tr.querySelector("input").addEventListener("input", (e) => {
            const q = Math.max(1, Number(e.target.value || 1));
            item.quantity = q;
            selected.set(item.productId, item);
            tr.querySelector(".lineTotal").textContent = (
              item.price * q
            ).toFixed(2);
            updateTotal();
          });

          // remove item
          tr.querySelector("button").addEventListener("click", () => {
            selected.delete(item.productId);
            const chk = document.getElementById(`p_${item.productId}`);
            if (chk) chk.checked = false;
            renderSelectedTable();
            renderProductList();
          });

          body.appendChild(tr);
        }

        updateTotal();
      }

      function updateTotal() {
        let total = 0;
        for (const item of selected.values()) {
          total += item.price * item.quantity;
        }
        document.getElementById("totalPrice").textContent = total.toFixed(2);
        document.getElementById("totalHidden").value = total.toFixed(2);
      }

      async function placeOrderNow() {
        const userId = document.getElementById("userSelect").value;

        if (!userId) {
          setAlert("Please select a customer.", "alert-warning");
          return;
        }

        if (selected.size === 0) {
          setAlert("Please select at least one product.", "alert-warning");
          return;
        }

        // Prepare items array for API
        const items = Array.from(selected.values()).map((it) => ({
          productId: it.productId,
          quantity: it.quantity,
        }));

        setAlert("Placing order...", "alert-info");

        try {
          const res = await fetch(`${API_BASE}/orders/place`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: Number(userId), items }),
          });

          const data = await res.json();

          if (!res.ok || !data.success) {
            setAlert(data.message || "Failed to place order.", "alert-danger");
            return;
          }

          setAlert(
            `Order placed! OrderID=${data.orderId}, Total=${Number(
              data.total
            ).toFixed(2)}`,
            "alert-success"
          );

          // refresh order table after success
          await fetchOrders();

          // close modal after a short moment
          setTimeout(() => {
            placeOrderModalInstance.hide();
          }, 800);
        } catch (err) {
          setAlert(err.message || String(err), "alert-danger");
        }
      }

      // initial load
      document.addEventListener("DOMContentLoaded", () => fetchOrders());
    </script>
  </body>
</html>
