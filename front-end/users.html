<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Users</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: #d0e7ff; /* light blue */
      }
      .accent-header {
        background: #3399ff !important; /* blue */
        color: white !important;
      }
      .btn-accent {
        background: #3399ff;
        color: #fff;
      }
      .btn-accent:hover {
        background: #66b2ff;
      }

      .profile-label {
        color: #3399ff;
      }
      .profile-input {
        background: #e6f2ff;
        border: 2px solid #3399ff;
        color: #3399ff;
      }
    </style>
  </head>

  <body>
    <div class="container mt-4">
      <h1 class="text-center mb-4" style="color: #3399ff">Users</h1>

      <button
        class="btn btn-accent mb-3"
        data-bs-toggle="modal"
        data-bs-target="#addUserModal"
      >
        Add User
      </button>

      <div class="table-responsive">
        <table
          class="table table-bordered table-hover shadow-sm"
          id="usersTable"
        >
          <thead class="accent-header">
            <tr id="userHeaderRow"></tr>
          </thead>
          <tbody id="userTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="modal fade" id="addUserModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header accent-header">
            <h5 class="modal-title">Add User</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <div class="modal-body">
            <label class="form-label">USERID</label>
            <input id="userid" class="form-control mb-2" />

            <label class="form-label">Full Name</label>
            <input id="fullname" class="form-control mb-2" />

            <label class="form-label">Email</label>
            <input id="email" class="form-control mb-2" />

            <label class="form-label">Password</label>
            <input id="password" type="password" class="form-control mb-2" />

            <label class="form-label">Address</label>
            <input id="address" class="form-control mb-2" />
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Cancel
            </button>
            <button class="btn btn-accent" onclick="submitUser()">
              Submit
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="userDetailModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header" style="background: #3399ff; color: white">
            <h5 class="modal-title">User Profile</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <div class="modal-body" id="userDetailContent"></div>

          <div class="modal-footer">
            <button class="btn btn-accent" data-bs-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      fetch("http://localhost:3001/users")
        .then((res) => res.json())
        .then((data) => {
          if (!data.success) return alert("Failed to load users");

          const rows = data.users;
          if (rows.length === 0) return;

          const headerRow = document.getElementById("userHeaderRow");
          const tableBody = document.getElementById("userTableBody");

          const headers = Object.keys(rows[0]);
          headers.forEach((h) => {
            const th = document.createElement("th");
            th.textContent = h;
            headerRow.appendChild(th);
          });

          rows.forEach((row) => {
            const tr = document.createElement("tr");
            tr.style.cursor = "pointer";

            const userId = row.USERID ?? row.userid ?? row.id ?? "";
            tr.dataset.userid = userId;

            tr.addEventListener("click", () => {
              const content = document.getElementById("userDetailContent");
              content.innerHTML = "<p>Loading user data...</p>";
              new bootstrap.Modal(
                document.getElementById("userDetailModal")
              ).show();
              openUserProfile(userId);
            });

            headers.forEach((h) => {
              const td = document.createElement("td");
              td.textContent = row[h];
              tr.appendChild(td);
            });

            tableBody.appendChild(tr);
          });
        })
        .catch((err) => {
          console.error("Error loading users:", err);
          alert("Error loading users");
        });

      function submitUser() {
        const data = {
          USERID: document.getElementById("userid").value,
          FULLNAME: document.getElementById("fullname").value,
          EMAIL: document.getElementById("email").value,
          PASSWORD: document.getElementById("password").value,
          ADDRESS: document.getElementById("address").value,
        };

        fetch("http://localhost:3001/addUser", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        })
          .then((r) => r.json())
          .then((res) => {
            if (res.success) {
              alert("User Added");
              location.reload();
            } else {
              alert(res.message);
            }
          });
      }

      async function openUserProfile(id) {
        try {
          const res = await fetch(
            `http://localhost:3001/user-profile/${encodeURIComponent(id)}`
          );
          const data = await res.json();

          if (!data.success) return alert(data.message);

          showUserModal(data.user);
        } catch (err) {
          console.error(err);
          alert("Error fetching user profile");
        }
      }

      function showUserModal(user) {
        const container = document.getElementById("userDetailContent");
        container.innerHTML = "";

        if (!user) {
          container.innerHTML = "<p>No data available.</p>";
          return;
        }

        for (const [key, value] of Object.entries(user)) {
          container.innerHTML += `
            <div class="mb-3">
              <label class="form-label fw-bold profile-label">${key}</label>
              <input class="form-control profile-input" value="${value}" readonly>
            </div>
          `;
        }
      }
    </script>
  </body>
</html>
